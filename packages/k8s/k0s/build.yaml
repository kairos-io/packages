requires:
- name: "toolchain-go-ubuntu"
  category: "development"
  version: ">=0"
env:
  - K0S_VERSION=v{{ regexReplaceAll "\\+\\d+$" .Values.version "" }}+k0s.{{.Values.k0s_version}}
steps:
  - curl -sfL https://get.k0s.sh > installer.sh
  {{ if eq .Values.name "k0s-openrc" }}
  # required by https://github.com/kardianos/service/blob/becf2eb62b83ed01f5e782cb8da7bb739ded2bb5/service_openrc_linux.go#L17
  - touch /sbin/openrc-init && chmod +x /sbin/openrc-init
  {{ else }}
  -  apt-get update && apt-get install -y systemctl
  - mkdir -p /etc/systemd/system/
  # required by https://github.com/kardianos/service/blob/becf2eb62b83ed01f5e782cb8da7bb739ded2bb5/service_systemd_linux.go#L23
  - mkdir -p /run/systemd/system
  {{ end }}
  - bash installer.sh
  - rm -rf installer.sh
  - k0s install controller --single --debug --verbose
  - chmod +x /usr/local/bin/k0s
  - upx -1 /usr/local/bin/k0s

includes:
- ^/usr/local/bin/k0s
{{ if eq .Values.name "k0s-openrc" }}
- ^/etc/init.d/$
- ^/etc/init.d/k0s*
- ^/etc/k0s/$
- ^/etc/k0s/k0s$
{{ else }}
- ^/etc/systemd$
- ^/etc/systemd/system$
- ^/etc/systemd/system/k0s*.service$
{{ end }}
